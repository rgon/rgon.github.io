<!DOCTYPE html>
<!-- 
    ** https://logotheclub.com
    ** quick and dirty coding by https://rgon.es
    ** (c) 2022 LOGO CLC
    **
    ** July 2021
-->
<html>
    <head>
        <title>LOGO | Circular Luxury Closet</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <!-- Include meta description, opengraph, analytics etc here -->
        
        <link rel="shortcut icon" type="image/svg" src="favicon.svg" />

        <link rel="stylesheet" href="fonts/source-sans/source-sans-3.css" />
        <link rel="stylesheet" href="fonts/main.css" />
        <link rel="stylesheet" href="main.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    </head>
    <body>
        <div class="bg bgTile bg_top"></div>
        <div class="bg bgTile bg_bottom"></div>

        <header>
            <img class="logo" src="assets/logoclaim_horizontal.svg">
        </header>

        <main>
            <div id="referralBanner">&iexcl;Gracias por aceptar la invitación de <span id="referee"></span>&excl;</div>

            <div class="centered centerpiece">
                <img class="centerpieceVideo" src="assets/firstBag.png" style="margin-top: 4px;">
                
                <a href="#" class="centered videoItem hidden grow" id="ctaLoQuiero"><img class="animate__animated animate__zoomIn" src="assets/loQuiero.svg"></a>
                <a href="#" class="centered videoItem hidden grow" id="ctaLoTengo"><img class="animate__animated animate__zoomIn" src="assets/loTengo.svg"></a>
                
                <a href="#" class="centered videoItem hidden grow" id="playVideo"><img class="animate__animated animate__zoomIn" src="assets/MDI_arrow_shadowed.svg"></a>
            </div>
        </main>

        <dialog id="dialogJoin">
            <div class="bg backdrop"></div>

            <img class="ctaHashtag" src="assets/cta_unetehashtag.svg">
            <form id="formJoin" oninput="this.classList.add('ready')">
                <input type="text" name="name" placeholder="Nombre Completo" pattern="^[a-zA-Z\u00C0-\u017F]{2,}(([,.] |[ '-])[a-zA-Z\u00C0-\u017F]{2,}){1,4}(\.?)$" required>
                <input type="email" name="email" placeholder="E-Mail" pattern="[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?" required>
                <input type="tel" name="phone" placeholder="Teléfono Móvil" pattern="^\(?\+?\d{0,4}\)?\s?[\d\s]{4,16}$" required>
                <div>
                    <label for="formPiece" id="quieroTengoLabel">Quiero un:</label>
                    <input id="formPiece" type="text" name="bag" placeholder="Saddle de Dior" pattern="^[a-zA-Z\u00C0-\u017F\d]+(([,.] |[ '-])([a-zA-Z\u00C0-\u017F]+|\d+)){0,4}(\.?)$" required>
                </div>

                <fieldset class="stripSelector" id="quieroTengoAmbos" name="quieroTengoAmbos">
                    <input type="radio" name="quieroTengoAmbos" id="quieroTengoAmbos_quiero" value="quiero">
                    <label for="quieroTengoAmbos_quiero">Lo Quiero</label>

                    <input type="radio" name="quieroTengoAmbos" id="quieroTengoAmbos_tengo" value="tengo">
                    <label for="quieroTengoAmbos_tengo">Lo Tengo</label>
                    
                    <input type="radio" name="quieroTengoAmbos" id="quieroTengoAmbos_todo" value="todo">
                    <label for="quieroTengoAmbos_todo">Ambos</label>
                </fieldset>

                <input type="hidden" id="formRh" name="rh" value="">
                <input type="hidden" id="formAt" name="at" value="">
                <input type="hidden" id="formVo" name="vo" value="false">
                <input type="hidden" id="formVw" name="vw" value="false">

                <div class="submit">
                    <label for="submit" class="terms">
                        Al pulsar enviar aceptas nuestra <a href="#">Política de Privacidad</a> y el uso de analíticas para comprobar la información introducida.
                        <!-- <a href="#">RECAPTCHA</a> -->
                    </label>
                    <input type="submit" value="Enviar" class="grow">
                </div>
            </form>
            
            <img class="close grow" src="assets/mdi_close.svg">
        </dialog>

        <dialog id="dialogShare">
            <div class="bg backdrop"></div>
            
            <!-- <object data="assets/invitationCard.svg" type="image/svg+xml" xmlns="http://www.w3.org/2000/svg" class="ctaHashtag" id="invitationCard"></object>
            -->
            <img class="ctaHashtag" id="invitationCard" src="assets/invitationCard.png">
            <section>
                <h3>&iexcl;Bienvenido, <span id="userName"></span>&excl;</h3>
                <p>La revolución de la economía circular te espera.</p>
                <p>Descarga tu tarjeta de invitación y compártela. &iexcl;Tendrás ventajas cuando invites a gente&excl;</p>
                <div style="z-index: 20;">
                    <a href="#" class="hidden shareLink grow" onclick="downloadInvitationCard()"><img class="shareLogo" src="assets/download-svgrepo-edit.svg"></a>
                    <a href="https://instagram.com/logo_clc" class="hidden shareLink grow"><img class="shareLogo" src="assets/whatsapp-svgrepo-edit.svg"></a>
                </div>
                <!-- https://codepen.io/heroheman/pen/XYMMBV -->
            </section>

            <img class="close grow" src="assets/mdi_close.svg">
        </dialog>

        <dialog id="dialogVideo">
            <div class="bg backdrop"></div>
            <!--
            <img class="centered centerpiece centerpieceVideo" src="assets/firstBag.full.png" style="margin-top: -1px;">
            -->
            
            <video class="centered centerpiece centerpieceVideo" id="campaignVideo"
            src="https://vid-cdn.website-editor.net/s/df7c136d544e4ea9a60cfd1142f67a2c/videos/6mPDgUyUT2l15twkabGw_LOGO_10-v.mp4?Expires=1660866846&amp;Signature=gMBgY1mj5O6sg~K4Mzalg9wS~qISRJHhMpxRZjPgnms9U5hS~SD0~0jbcu0828m2QzhcPIUKmpNqTHzBCMVbGCCUd5fT-rkIzT5Pm7MTigLzsTh7Vo1gqOBELXQuCCGSWp32UGDyqVlBFspEoc0xYqKte~krYbifJt5vIVVzJr7Bxg8gRhVA5gMMAQLwPSKHjXZFivr2gAMlywICvXASPoXCSZcrW0LJJtQ5aIytwm1j9c~JdgB8WIz57n9K3WLL~s51VRnUD58RkF74KDWpfYgG7XHR3dljlsxJOKZePpCD~7JIfzH4Arm2HGOgy~eAdTSdL2oL3XoQ5RwhBlVe6w__&amp;Key-Pair-Id=K2NXBXLF010TJW" data-src="https://vid-cdn.website-editor.net/s/df7c136d544e4ea9a60cfd1142f67a2c/videos/6mPDgUyUT2l15twkabGw_LOGO_10-v.mp4" poster="https://cdn.website-editor.net/s/df7c136d544e4ea9a60cfd1142f67a2c/dms3rep/multi/6mPDgUyUT2l15twkabGw_LOGO_10.v2.0000000.jpg?Expires=1660866846&amp;Signature=oQV9JXwnBHIj6t-52u2PqvURZSMBmr45d1gW0DtGqt7Uu2HRVDg83KEUcEJ5A5WT39E38eOqbw-9F3iOEbKAjqVYlz3-fO56qP5XmEaoiLVQquzfA3XvMtcnP0CcfWNI4wdLdhg~Sz1pB7p2JHLkhHqP9KbFjgha-sLCnA9dGKIE4qjV0cLqnggu48l4WOjzUD2Con8L2bjEtZLM4mZy2-bqi8S5cdV0YoYcTeip990RcH2HX5lmkBFp87~aA-ENmgLZQHpQhuFqCcgbfz0nQT6DHuSzLbN45ed50UfNmP8Z-GfpX7KHmBIBR6LqkdJBJ0AXzGgdbt~p2lpGRPQszQ__&amp;Key-Pair-Id=K2NXBXLF010TJW" 
            playsinline="true" preload="auto"></video>

            <img class="close grow" src="assets/mdi_close.svg">
        </dialog>

        <dialog id="dialogAbout" class="dialogAbout">
            <div class="bg backdrop"></div>
            
            <img class="ctaHashtag" src="assets/cta_unetehashtag.svg">
            <section>
                <p>La revolución de la economía circular ha llegado para invadir tu closet. LOGO te da la bienvenida tanto si deseas disfrutar de nuestros planes que dan acceso al closet de tus sueños, como si deseas que nosotros gestionemos tus bolsos para que ganes sin darte ni cuenta.</p>
                <p>¡Y por supuesto, ambas opciones!</p>
                <p>Estamos desarrollando una nueva APP para que puedas disfrutar de estos servicios.</p>
                <button onclick="document.querySelector('#dialogAbout').open = false; document.querySelector('#dialogJoin').open = true">&iexcl;Manténme informada!</button>
            </section>

            <img class="close grow" src="assets/mdi_close.svg">
        </dialog>

        <dialog id="cookieBanner" open>
            <div class="bg backdrop"></div>

            <div>
                <section>
                    <h3>Usamos Cookies.</h3>
                    <p>Pulsa Aceptar para continuar o lee nuestra <a href="#">Política de Privacidad</a>.</p>
                </section>
            </div>

            <button id="acceptCookies">Aceptar</button>
        </dialog>
        <footer>
            <ul>
                <li><a href="#" onclick="document.querySelector('#dialogAbout').open = true">¿Cómo funciona?</a></li>
                <li><a href="https://instagram.com/logo_clc" class="hidden"><img class="iglogo grow" src="assets/iglogo.svg" style="margin-top: .2em;"></a></li>
                <li><a href="#">Política de Privacidad</a></li>
            </ul>
            <img class="inlineLogo" src="assets/logocopyright.svg" alt="&copy;LOGO 2022">
        </footer>

<script src="svg-export.min.js"></script>
<script src="https://unpkg.com/canvg"></script>

<script type="text/javascript">
    /*
    ** UI Components
    */
    function updateQuieroTengoLabels () {
        const val = document.forms['formJoin'].elements['quieroTengoAmbos'].value
        if (val === 'quiero') {
            document.querySelector('#quieroTengoLabel').innerHTML = 'Quiero un:'
        } else if (val === 'tengo') {
            document.querySelector('#quieroTengoLabel').innerHTML = 'Tengo un:'
        } else {
            document.querySelector('#quieroTengoLabel').innerHTML = '&iexcl;Amo! el:'
        }
    }

    document.querySelector('#ctaLoQuiero').addEventListener('click', () => {
        document.forms['formJoin'].elements['quieroTengoAmbos'].value = 'quiero'
        updateQuieroTengoLabels()
        document.querySelector('#quieroTengoLabel').innerHTML = 'Quiero un:'
        document.querySelector('#dialogJoin').open = true
    })
    document.querySelector('#ctaLoTengo').addEventListener('click', () => {
        document.forms['formJoin'].elements['quieroTengoAmbos'].value = 'tengo'
        updateQuieroTengoLabels()
        document.querySelector('#dialogJoin').open = true
    })
    document.querySelector('#playVideo').addEventListener('click', () => {
        document.querySelector('#dialogVideo').open = true
        setTimeout(() => {
            document.querySelector('#campaignVideo').play()
        }, 100)
    })
    document.querySelector('#quieroTengoAmbos').addEventListener('change', updateQuieroTengoLabels)

    document.querySelectorAll('dialog > .close').forEach((closeButton) => {
        addEventListener('click', (e) => {
            e.target.parentNode.open = false
            document.querySelector('#campaignVideo').pause()
        })
    })

    /*
    ** GDPR
    */
    // sets the cookie cookie2 (cookie1 is *not* overwritten)
    // document.cookie = 'cookie2=test; expires=Sun, 1 Jan 2023 00:00:00 UTC; path=/'
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('body').classList.add('gdprWaiting')
    })
    document.querySelector('#acceptCookies').addEventListener('click', () => {
        document.querySelector('#cookieBanner').open = false
        document.querySelector('body').classList.remove('gdprWaiting')
    })
    // Reject by clicking outside. Restore animations.
    var observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'attributes') {
                // must mean the 'open' attribute has changed, thus GDPR dialog was closed
                console.log('GDPR dialog closed forcefully.')
                document.querySelector('body').classList.remove('gdprWaiting')
            }
        });
    });
    observer.observe(document.querySelector('#cookieBanner'), {
        attributes: true // configure it to listen to attribute changes
    });

    /*
    ** Video Analytics
    */
    var observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'attributes') {
                // Video dialog was opened and thus must start playing
                document.querySelector('#formVo').value = true
            }
        });
    });
    observer.observe(document.querySelector('#dialogVideo'), {
        attributes: true // configure it to listen to attribute changes: open attribute
    });
    document.querySelector('#campaignVideo').addEventListener('ended', () => {
        document.querySelector('#formVw').value = true
        setTimeout(() => {
            document.querySelector('#dialogVideo').open = false
            document.querySelector('#dialogJoin').open = true
        }, 400)
    })

    /*
    ** Form Validation (legacy, moved to HTML)
    */
   /*
    function validateEmail (data) {
        // RFC2822 https://regexr.com/2rhq7
        const re = /[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/
        return data.match(re)
    }
    function validatePhone (data) {
        // https://www.quora.com/Which-countries-have-the-shortest-and-longest-phone-numbers-country-code-included
        const re = /^\(?\+?\d{0,4}\)?\s?[\d\s]{4,16}$/
        return data.match(re)
    }
    function validateBag (data) {
        const re = /^[a-zA-Z\u00C0-\u017F\d]+(([,.] |[ '-])([a-zA-Z\u00C0-\u017F]+|\d+)){0,4}(\.?)$/
        return data.match(re)
    }
    function validateName (data) {
        const re = /^[a-zA-Z\u00C0-\u017F]{2,}(([,.] |[ '-])[a-zA-Z\u00C0-\u017F]{2,}){1,4}(\.?)$/
        return data.match(re)
    }
    */

    /*
    ** Form submission & registration
    */
    document.querySelector('#formJoin').addEventListener('submit', async (e) => {
        e.preventDefault() // Before the code
        console.log(e)
        const firstName = e.target.elements['name'].value.split(' ')[0]

        // Edit Welcome Tag
        document.querySelector('#userName').innerHTML = firstName
        
        // Edit SVG
        document.querySelector('#dialogJoin').open = false
        document.querySelector('#dialogShare').open = true
        
        // TODO proper
        setTimeout(()=> {
            document.getElementById("customCTA").textContent = "My Value";
        }, 200)

        // Get form data here
        // TODO send data

        // const res = await fetch('http://api.logotheclub.com/referral/unhash')
    })
    function downloadInvitationCard () {
        svgExport.downloadJpeg("#invitationCard", "Invitation to LOGO");
    }

    /*
    ** Referral Algorithm
    */
    class NetworkError extends Error {}

    async function getRefereeName (rh) {
        return rh
        
        // TODO fetch data
        try {
            const res = await fetch('http://api.logotheclub.com/referral/unhash')
            const json = await res.json()

        } catch (e) {
            throw new NetworkError(e)
        }

        console.log(json)

        return rh
    }

    async function main () {
        const visitUnixTime = Math.floor((new Date()).getTime() / 1000)
        document.querySelector('#formAt').value = visitUnixTime

        // ----------- Get referee data
        const urlParams = new URLSearchParams(window.location.search)
        const refereeHash = urlParams.get('rh')

        if (refereeHash) {
            console.log('Invited by hash ' + refereeHash)
    
            try {
                document.querySelector('#formRh').value = refereeHash
                document.querySelector('#referee').innerHTML = await getRefereeName(refereeHash)
                document.querySelector('#referralBanner').style.visibility = 'visible'
            } catch (e) {
                if (e instanceof NetworkError) {
                    console.log('Network error while fetching referee from hash. Ignoring.', e)
                } else {
                    console.log('Invalid referral hash. Ignoring.', e)
                }
            }
        } else {
            console.log('Organic visit, not invited by others.')
        }
    }

    document.addEventListener('DOMContentLoaded', main)
</script>
    </body>
</html>